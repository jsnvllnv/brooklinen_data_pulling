select  
	to_char(local_date_created::date,'mm/dd/yyyy') as local_date_created,
	extract(hour from started_at) as hour_started,
	agent_name,
	duration_api::varchar
from 
	(
		select 
			*,
			sum(duration_api) over (partition by left(started_at::varchar,10)::date, agent_name) as daily,
			avg(duration_api) over (partition by left(started_at::varchar,10)::date, agent_name) as avg_daily
		from 
			(
				select
					distinct 
					call_id,
					user_id as assignee_id,
					agent_name,
					email_address,
					job_supervisor,
					left(started_at::varchar,10)::date as local_date_created,
					started_at,
					duration_call as duration_api 
				from 
					(
						select 
							call_id,
							left(user_id,6)::varchar as user_id,
							agent_name,
							started_at,
							email_address,
							job_supervisor,
							job_effectivity_date,
							date_started_local - job_effectivity_date as recent,
							min(date_started_local - job_effectivity_date) over (partition by call_id, date_started_local, agent_name) as recent_date,
							date_started_local,
							time_started_local,
							direction,
							duration_total,
							duration_api,
							duration_call
						from 
							aircall_phone_calls
						left join
							(
								select 
									agents.assignee_id,
									agents.agent_name,
									email_address,
									job_supervisor,
									job_effectivity_date
								from aircall_users
								left join
									(
										select 
											agent_name,
											email_address,
											assignee_id,
											job_supervisor,
											job_effectivity_date
										from sd_hris_team_roster shtr 
										left join 
											(
												select
													assignee_id,
													agent_name,
													agent_email 
												from 
													sd_agent_roster
												where 
													client_account = 'brooklinen'
													and crm_tool = 'aircall'
											) as ar 
											on ar.agent_email = shtr.email_address 
										where 
											job_division = 'Brooklinen'
												and shtr.email_address is not null
												and agent_name is not null
												and assignee_id is not null
												and profile_status = 'Active'
									) as agents
									on aircall_users.assignee_id = agents.assignee_id 
								where
									agent_email like ('%boldrimpact%')
									and email_address is not null
							) as call_agents
							on (assignee_id = left(user_id,6)::varchar 
							and date_started_local >= job_effectivity_date
							)
						where 
							left(user_id,6)::varchar is not null
							and direction = 'inbound' and status = 'done'
							and duration_api is not null
							and agent_name is not null
							and line = 'Brooklinen CX Team NEW'
							and time_started_local between '08:00:00' and '21:00:00'
							and missed_call_reason is null 
					) as aht_raw_duplicates
				where 
					recent = recent_date
			) as remove_duplicates
		order by 
			started_at
	) as check_aircall
where 	
	local_date_created >= '2022-01-01'
order by 
	started_at,
	agent_name
