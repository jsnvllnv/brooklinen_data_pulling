with agents as (
select 
	agent_name,
	email_address,
	assignee_id,
	job_supervisor,
	job_effectivity_date
from sd_hris_team_roster shtr 
left join 
	(
		select
			assignee_id,
			agent_name,
			agent_email 
		from 
			sd_agent_roster
		where 
			client_account = 'brooklinen'
			and crm_tool = 'aircall'
	) as ar 
	on ar.agent_email = shtr.email_address 
where 
	job_division = 'Brooklinen'
		and shtr.email_address is not null
		and agent_name is not null
		and assignee_id is not null
		and profile_status = 'Active'
)
--select * from agents
,
call_agents as (
select 
	agents.assignee_id,
	agents.agent_name,
	email_address,
	job_supervisor,
	job_effectivity_date
from aircall_users
left join
	agents
	on aircall_users.assignee_id = agents.assignee_id 
where
	agent_email like ('%boldrimpact%')
	and email_address is not null
)
--select * from call_agents
,
out_hrs as (
select 
	started_at,
	direction,
	missed_call_reason
from 
	aircall_phone_calls
where 
	direction = 'inbound'
	and missed_call_reason = 'out_of_opening_hours'
	and status = 'done'
)
, 
not_answer as (
select 
	started_at,
	direction,
	missed_call_reason
from 
	aircall_phone_calls
where 
	direction = 'inbound'
	and missed_call_reason = 'agents_did_not_answer'
	and status = 'done'
)
, no_agent as (
select 
	started_at,
	direction,
	missed_call_reason
from 
	aircall_phone_calls
where 
	direction = 'inbound'
	and missed_call_reason = 'no_available_agent'
	and status = 'done'
)
,
extract_hour_1 as (
select 
	*,
	extract(hour from started_at) as hour_
from out_hrs
)
,
extract_hour_2 as (
select 
	*,
	extract(hour from started_at) as hour_
from not_answer
)
,
extract_hour_3 as (
select 
	*,
	extract(hour from started_at) as hour_
from no_agent
)
,
extract_date as (
select 
	started_at, 
	extract(hour from started_at) as hour_,
	left(started_at::varchar,10)::date as period_
from aircall_phone_calls 
where direction = 'inbound' and status = 'done'
order by started_at 
)
,
total_calls as (
select 
	distinct
	period_,
	count(*) over (partition by period_) as total_inbound_calls
from 
	extract_date
order by 
	period_
)
,
extract_mc_date_1 as (
select 
	*,
	left(started_at::varchar,10)::date as period_,
	count(*) over (partition by date(left(started_at::varchar,10)::date)) as out_hrs
from extract_hour_1
)
,
extract_mc_date_2 as (
select 
	*,
	left(started_at::varchar,10)::date as period_,
	count(*) over (partition by date(left(started_at::varchar,10)::date)) as not_answer
from extract_hour_2
)
,
extract_mc_date_3 as (
select 
	*,
	left(started_at::varchar,10)::date as period_,
	count(*) over (partition by date(left(started_at::varchar,10)::date)) as no_agent
from extract_hour_3
)
,
raw_mc as (
select 
	distinct
	total_calls.period_,
	out_hrs,
	not_answer,
	no_agent,
	total_calls.total_inbound_calls,
	round((((out_hrs::float)/total_calls.total_inbound_calls)*100)::numeric,1) as out_hrs_p,
	round((((not_answer::float)/total_calls.total_inbound_calls)*100)::numeric,1) as not_answer_p,
	round((((no_agent::float)/total_calls.total_inbound_calls)*100)::numeric,1) as no_agent_p
from 
	total_calls
left join
	extract_mc_date_1
	on total_calls.period_ = extract_mc_date_1.period_
left join
	extract_mc_date_2
	on total_calls.period_ = extract_mc_date_2.period_
left join
	extract_mc_date_3
	on total_calls.period_ = extract_mc_date_3.period_
order by 
	period_ 
)
,
percent_mc as (
select 
	period_,
	out_hrs,
	not_answer,
	no_agent,
	total_inbound_calls,
	case when out_hrs_p is null then 0 else out_hrs_p end as out_hrs_p,
	case when not_answer_p is null then 0 else not_answer_p end as not_answer_p,
	case when no_agent_p is null then 0 else no_agent_p end as no_agent_p
from 
	raw_mc
)
,
extract_scorecard as (
select
	*,
	(out_hrs_p + not_answer_p + no_agent_p) as total_mc
from 
	percent_mc
),
duplicates as (
select
	period_ as local_date_created,
	out_hrs,
	not_answer,
	no_agent,	
	total_inbound_calls,
	out_hrs_p,
	not_answer_p,
	no_agent_p,
	total_mc as daily,
	agent_name,
	email_address,
	job_supervisor,
	job_effectivity_date,
	period_ - job_effectivity_date as recent,
	min(period_ - job_effectivity_date) over (partition by period_, agent_name) as recent_
from 
	extract_scorecard
left join
	call_agents
	on (period_ >= job_effectivity_date)
)
, daily as (
select 
	distinct
	local_date_created,
	agent_name,
	email_address,
	job_supervisor as supervisor,
	out_hrs,
	not_answer,
	no_agent,
	total_inbound_calls,
	daily/100 as daily
from duplicates
where 
	recent = recent_
)
,daily_no as (
select 
    'brooklinen' as client_account,
    'daily' as period,
	local_date_created,
	'voice' as channel,
	'' as assignee_id,
	email_address,
	agent_name,
	supervisor,
	'missed_calls_p' as kpi_metric,
	daily as score,
    case 
            when local_date_created < (select (select start_date from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new'))
            then (select target from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='old')
            when local_date_created >= (select (select start_date from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new'))
            then (select target from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new')
    end as target,	
    (select weight from kpi_data_warehouse.sd_kpi_weights 
                    where client_account = 'brooklinen' 
                    and kpi = 'missed_call' 
                    and channel = 'voice'
                    and metric= 'all'
    ) as weight  	
from daily
)
,
final_daily as (
select
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	email_address,
	agent_name,
	supervisor,
	kpi_metric,
	case 
		when score is null
		then 0
		else score
	end as score,
	target,
	case 
	    when (target = 0.12) and (score <= (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km
	        where km.rating = 5
	        and km.client_account = 'brooklinen'
	        and km.channel = 'voice'
	        and km.kpi = 'missed_call'
	        and km.metric = 'old'))
	    then 5
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km
	            where km.rating = 4
	            and km.client_account = 'brooklinen'
	            and km.channel = 'voice'
	            and km.kpi = 'missed_call'
	            and metric = 'old')
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 4 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old'))
	    then 4
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') )
	    then 3
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old')) 
	    then 2
	    when (target = 0.12) and (score >= (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	        where km.rating = 1 
	        and km.client_account = 'brooklinen' 
	        and km.channel = 'voice' 
	        and km.kpi = 'missed_call'
	        and metric = 'old') )
	    then 1
	    when (target = 0.1) and (score <= (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km
	        where km.rating = 5
	        and km.client_account = 'brooklinen'
	        and km.channel = 'voice'
	        and km.kpi = 'missed_call'
	        and km.metric = 'new'))
	    then 5
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km
	            where km.rating = 4
	            and km.client_account = 'brooklinen'
	            and km.channel = 'voice'
	            and km.kpi = 'missed_call'
	            and metric = 'new')
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 4 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new'))
	    then 4
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') )
	    then 3
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new')) 
	    then 2
	    when (target = 0.1) and (score >= (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	        where km.rating = 1 
	        and km.client_account = 'brooklinen' 
	        and km.channel = 'voice' 
	        and km.kpi = 'missed_call'
	        and metric = 'new')) 
	    then 1 
	else 5
	end as rating,	
	weight
from 
	daily_no
)
,
final_team_daily as (
select 
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	'' as assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	'Team Total' as supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from final_daily
)
,
final_team_visor_daily as (
select 
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	'' as assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	rating,	
	weight
from final_daily
)
,
raw_breakdown as (
select 
	local_date_created,
	date(date_trunc('week',local_date_created)) as week_date,
	date(date_trunc('month',local_date_created)) as month_date,
	out_hrs,
	not_answer,
	no_agent,
	total_inbound_calls,
	sum(out_hrs) over (partition by date(date_trunc('week',local_date_created)), email_address) as out_hrs_w,
	sum(not_answer) over (partition by date(date_trunc('week',local_date_created)), email_address) as not_answer_w,
	sum(no_agent) over (partition by date(date_trunc('week',local_date_created)), email_address) as no_agent_w,
	sum(total_inbound_calls) over (partition by date(date_trunc('week',local_date_created)), email_address) as total_calls_w,
	sum(out_hrs) over (partition by date(date_trunc('month',local_date_created)), email_address) as out_hrs_m,
	sum(not_answer) over (partition by date(date_trunc('month',local_date_created)), email_address) as not_answer_m,
	sum(no_agent) over (partition by date(date_trunc('month',local_date_created)), email_address) as no_agent_m,
	sum(total_inbound_calls) over (partition by date(date_trunc('month',local_date_created)), email_address) as total_calls_m,	
	agent_name,
	email_address,
	job_supervisor as supervisor
from duplicates
where 
	recent = recent_
)
,
raw_weekly as (
select
	distinct 
	week_date as local_date_created,
	out_hrs_w,
	not_answer_w,
	no_agent_w,
	total_calls_w,
	round((((out_hrs_w::float)/total_calls_w)*100)::numeric,1) as out_hrs_p,
	round((((not_answer_w::float)/total_calls_w)*100)::numeric,1) as not_answer_p,
	round((((no_agent_w::float)/total_calls_w)*100)::numeric,1) as no_agent_p,	
	agent_name,
	email_address,
	supervisor
from raw_breakdown
)
, 
weekly_no as (
select 
    'brooklinen' as client_account,
    'weekly' as period,
	local_date_created,
	'voice' as channel,
	'' as assignee_id,
	email_address,
	agent_name,
	supervisor,
	'missed_calls_p' as kpi_metric,	
	(out_hrs_p+not_answer_p+no_agent_p)/100 as score,
    case 
            when local_date_created < (select (select start_date from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new'))
            then (select target from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='old')
            when local_date_created >= (select (select start_date from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new'))
            then (select target from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new')
    end as target,
    (select weight from kpi_data_warehouse.sd_kpi_weights 
                    where client_account = 'brooklinen' 
                    and kpi = 'missed_call' 
                    and channel = 'voice'
                    and metric= 'all'	
    ) as weight  	                    
from 
	raw_weekly
)
,
final_weekly as (
select
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	email_address,
	agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	case 
	    when (target = 0.12) and (score <= (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km
	        where km.rating = 5
	        and km.client_account = 'brooklinen'
	        and km.channel = 'voice'
	        and km.kpi = 'missed_call'
	        and km.metric = 'old'))
	    then 5
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km
	            where km.rating = 4
	            and km.client_account = 'brooklinen'
	            and km.channel = 'voice'
	            and km.kpi = 'missed_call'
	            and metric = 'old')
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 4 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old'))
	    then 4
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') )
	    then 3
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old')) 
	    then 2
	    when (target = 0.12) and (score >= (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	        where km.rating = 1 
	        and km.client_account = 'brooklinen' 
	        and km.channel = 'voice' 
	        and km.kpi = 'missed_call'
	        and metric = 'old') )
	    then 1
	    when (target = 0.1) and (score <= (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km
	        where km.rating = 5
	        and km.client_account = 'brooklinen'
	        and km.channel = 'voice'
	        and km.kpi = 'missed_call'
	        and km.metric = 'new'))
	    then 5
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km
	            where km.rating = 4
	            and km.client_account = 'brooklinen'
	            and km.channel = 'voice'
	            and km.kpi = 'missed_call'
	            and metric = 'new')
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 4 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new'))
	    then 4
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') )
	    then 3
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new')) 
	    then 2
	    when (target = 0.1) and (score >= (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	        where km.rating = 1 
	        and km.client_account = 'brooklinen' 
	        and km.channel = 'voice' 
	        and km.kpi = 'missed_call'
	        and metric = 'new')) 
	    then 1 
	else 5
	end as rating,	
	weight
from 
	weekly_no
)
,
final_team_weekly as (
select
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	'' as assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	'Team Total' as supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from final_weekly
order by local_date_created
)
,
final_team_visor_weekly as (
select 
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	'' as assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from final_weekly
order by local_date_created
)
,
raw_monthly as (
select
	distinct 
	month_date as local_date_created,
	out_hrs_m,
	not_answer_m,
	no_agent_m,
	total_calls_m,
	round((((out_hrs_m::float)/total_calls_m)*100)::numeric,1) as out_hrs_p,
	round((((not_answer_m::float)/total_calls_m)*100)::numeric,1) as not_answer_p,
	round((((no_agent_m::float)/total_calls_m)*100)::numeric,1) as no_agent_p,	
	agent_name,
	email_address,
	supervisor
from raw_breakdown
)
, 
monthly_no as (
select 
    'brooklinen' as client_account,
    'monthly' as period,
	local_date_created,
	'voice' as channel,
	'' as assignee_id,
	email_address,
	agent_name,
	supervisor,
	'missed_calls_p' as kpi_metric,	
	(out_hrs_p+not_answer_p+no_agent_p)/100 as score,
    case 
            when local_date_created < (select (select start_date from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new'))
            then (select target from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='old')
            when local_date_created >= (select (select start_date from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new'))
            then (select target from kpi_data_warehouse.sd_performance_target where client_account = 'brooklinen'
                        and channel = 'voice' 
                        and kpi = 'missed_call'
                        and metric='new')
    end as target,
    (select weight from kpi_data_warehouse.sd_kpi_weights 
                    where client_account = 'brooklinen' 
                    and kpi = 'missed_call' 
                    and channel = 'voice'
                    and metric= 'all'	
    ) as weight  	                    
from 
	raw_monthly
)
,
final_monthly as (
select
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	email_address,
	agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	case 
	    when (target = 0.12) and (score <= (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km
	        where km.rating = 5
	        and km.client_account = 'brooklinen'
	        and km.channel = 'voice'
	        and km.kpi = 'missed_call'
	        and km.metric = 'old'))
	    then 5
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km
	            where km.rating = 4
	            and km.client_account = 'brooklinen'
	            and km.channel = 'voice'
	            and km.kpi = 'missed_call'
	            and metric = 'old')
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 4 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old'))
	    then 4
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') )
	    then 3
	    when (target = 0.12) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old')) 
	    then 2
	    when (target = 0.12) and (score >= (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	        where km.rating = 1 
	        and km.client_account = 'brooklinen' 
	        and km.channel = 'voice' 
	        and km.kpi = 'missed_call'
	        and metric = 'old') )
	    then 1
	    when (target = 0.1) and (score <= (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km
	        where km.rating = 5
	        and km.client_account = 'brooklinen'
	        and km.channel = 'voice'
	        and km.kpi = 'missed_call'
	        and km.metric = 'new'))
	    then 5
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km
	            where km.rating = 4
	            and km.client_account = 'brooklinen'
	            and km.channel = 'voice'
	            and km.kpi = 'missed_call'
	            and metric = 'new')
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 4 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new'))
	    then 4
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') )
	    then 3
	    when (target = 0.1) and (score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new')) 
	    then 2
	    when (target = 0.1) and (score >= (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	        where km.rating = 1 
	        and km.client_account = 'brooklinen' 
	        and km.channel = 'voice' 
	        and km.kpi = 'missed_call'
	        and metric = 'new')) 
	    then 1 
	else 5
	end as rating,	
	weight
from 
	monthly_no
)
,
final_team_monthly as (
select
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	'' as assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	'Team Total' as supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from final_monthly
)
,
final_team_visor_monthly as (
select 
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	'' as assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from final_monthly
)
--select * from monthly_no
--select * from final_monthly
,
remove_not_scores as (
select 
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	'Team Total' as supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight,
	count(score) over (partition by local_date_created, score) as count_
from final_weekly
)
,
max_count_w as (
select 
	*,
	max(count_) over (partition by local_date_created) as max_
from
remove_not_scores
)
,
correct_final_team_weekly as (
select 
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	email_address,
	agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from 
	max_count_w
where 
	count_ = max_
order by local_date_created
)
,
remove_not_scores_w_visor as (
select 
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight,
	count(score) over (partition by local_date_created, score) as count_
from 
	final_weekly
)
,
max_count_w_visor as (
select 
	*,
	max(count_) over (partition by local_date_created) as max_
from
	remove_not_scores_w_visor
)
,
correct_final_visor_weekly as (
select 
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	email_address,
	agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from 
	max_count_w_visor
where 
	count_ = max_
order by local_date_created
)
--select * from correct_final_visor_weekly
--select * from raw_breakdown
--select 
--	*,
--	date(date_trunc('week',local_date_created)) as week_date,
--	sum(out_hrs) over (partition by date(date_trunc('week',local_date_created)), agent_name) as out_hrs_w,
--	sum(not_answer) over (partition by date(date_trunc('week',local_date_created)), agent_name) as out_hrs_w,
--	sum(no_agent) over (partition by date(date_trunc('week',local_date_created)), agent_name) as out_hrs_w,
--from daily
,
remove_not_scores_m as (
select 
	*,
	count(score) over (partition by local_date_created, score) as count_ 
from final_monthly
)
,
max_count_m as (
select 
	*,
	max(count_) over (partition by local_date_created) as max_
from
	remove_not_scores_m
)
,
correct_score as (
select 
	*,
	case 
		when count_ = max_ then score
		else 0
	end as correct_score
from max_count_m
)
,
uni_score as (
select 
	*,
	max(correct_score) over (partition by local_date_created) as uni_score
from 
	correct_score
)
,
correct_final_monthly as (
select
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	email_address,
	agent_name,
	supervisor,
	kpi_metric,
	uni_score as score,
	target,
	case 
	    when (target = 0.12) and (uni_score <= (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km
	        where km.rating = 5
	        and km.client_account = 'brooklinen'
	        and km.channel = 'voice'
	        and km.kpi = 'missed_call'
	        and km.metric = 'old'))
	    then 5
	    when (target = 0.12) and (uni_score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km
	            where km.rating = 4
	            and km.client_account = 'brooklinen'
	            and km.channel = 'voice'
	            and km.kpi = 'missed_call'
	            and metric = 'old')
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 4 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old'))
	    then 4
	    when (target = 0.12) and (uni_score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') )
	    then 3
	    when (target = 0.12) and (uni_score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'old')) 
	    then 2
	    when (target = 0.12) and (uni_score >= (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	        where km.rating = 1 
	        and km.client_account = 'brooklinen' 
	        and km.channel = 'voice' 
	        and km.kpi = 'missed_call'
	        and metric = 'old') )
	    then 1
	    when (target = 0.1) and (uni_score <= (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km
	        where km.rating = 5
	        and km.client_account = 'brooklinen'
	        and km.channel = 'voice'
	        and km.kpi = 'missed_call'
	        and km.metric = 'new'))
	    then 5
	    when (target = 0.1) and (uni_score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km
	            where km.rating = 4
	            and km.client_account = 'brooklinen'
	            and km.channel = 'voice'
	            and km.kpi = 'missed_call'
	            and metric = 'new')
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 4 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new'))
	    then 4
	    when (target = 0.1) and (uni_score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 3 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') )
	    then 3
	    when (target = 0.1) and (uni_score
	        between (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new') 
	        and (select km.ceiling from kpi_data_warehouse.sd_kpi_metrics km 
	            where km.rating = 2 
	            and km.client_account = 'brooklinen' 
	            and km.channel = 'voice' 
	            and km.kpi = 'missed_call'
	            and metric = 'new')) 
	    then 2
	    when (target = 0.1) and (uni_score >= (select km.base from kpi_data_warehouse.sd_kpi_metrics km 
	        where km.rating = 1 
	        and km.client_account = 'brooklinen' 
	        and km.channel = 'voice' 
	        and km.kpi = 'missed_call'
	        and metric = 'new')) 
	    then 1 
	else 5
	end as rating,		
	weight
from 
	uni_score
)
,
correct_final_team_monthly as (
select
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	'Team Total' as supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from 
	correct_final_monthly
order by local_date_created
)
,
correct_final_visor_monthly as (
select
	distinct
	client_account,
	period,
	local_date_created,
	channel,
	assignee_id,
	'' as email_address,
	'Team Total' as agent_name,
	supervisor,
	kpi_metric,
	score,
	target,
	rating,
	weight
from 
	correct_final_monthly
order by local_date_created
)
select 
	period_,
	out_hrs,
	not_answer,
	no_agent,
	total_inbound_calls,
	total_mc
from extract_scorecard
